<!DOCTYPE html>
<html>
<head>
  <style>
    /* ============================================
       CALCITE DESIGN SYSTEM - FIGMA PLUGIN THEME
       ============================================ */
    
    :root {
      /* Calcite Colors - Light Theme */
      --calcite-ui-brand: #007ac2;
      --calcite-ui-brand-hover: #00619b;
      --calcite-ui-brand-press: #004874;
      --calcite-ui-background: #f8f8f8;
      --calcite-ui-foreground-1: #ffffff;
      --calcite-ui-foreground-2: #f3f3f3;
      --calcite-ui-foreground-3: #eaeaea;
      --calcite-ui-text-1: #151515;
      --calcite-ui-text-2: #4a4a4a;
      --calcite-ui-text-3: #6a6a6a;
      --calcite-ui-text-inverse: #ffffff;
      --calcite-ui-border-1: #cacaca;
      --calcite-ui-border-2: #d4d4d4;
      --calcite-ui-border-3: #dfdfdf;
      --calcite-ui-border-input: #949494;
      --calcite-ui-info: #00619b;
      --calcite-ui-success: #35ac46;
      --calcite-ui-warning: #edd317;
      --calcite-ui-danger: #d83020;
      
      /* Typography */
      --calcite-font-family: "Avenir Next", "Avenir", "Helvetica Neue", sans-serif;
      --calcite-font-size-sm: 12px;
      --calcite-font-size-md: 14px;
      --calcite-font-size-lg: 16px;
      
      /* Spacing */
      --calcite-spacing-xxs: 4px;
      --calcite-spacing-xs: 8px;
      --calcite-spacing-sm: 12px;
      --calcite-spacing-md: 16px;
      --calcite-spacing-lg: 20px;
      
      /* Shadows */
      --calcite-shadow-sm: 0 1px 2px rgba(0,0,0,0.1);
      --calcite-shadow-md: 0 2px 6px rgba(0,0,0,0.15);
      
      /* Border Radius */
      --calcite-border-radius: 4px;
      --calcite-border-radius-round: 50%;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: var(--calcite-font-family);
      font-size: var(--calcite-font-size-md);
      color: var(--calcite-ui-text-1);
      background: var(--calcite-ui-background);
      height: 100vh;
      overflow: hidden;
    }

    /* ============================================
       LAYOUT
       ============================================ */
    
    .plugin-container {
      display: flex;
      height: 100vh;
      flex-direction: column;
    }

    .header {
      background: var(--calcite-ui-foreground-1);
      border-bottom: 1px solid var(--calcite-ui-border-2);
      padding: var(--calcite-spacing-sm) var(--calcite-spacing-md);
      flex-shrink: 0;
    }

    .header-title {
      font-size: var(--calcite-font-size-lg);
      font-weight: 600;
      color: var(--calcite-ui-text-1);
      margin-bottom: var(--calcite-spacing-xs);
    }

    .search-container {
      display: flex;
      gap: var(--calcite-spacing-xs);
    }

    .search-input {
      flex: 1;
      height: 32px;
      padding: 0 var(--calcite-spacing-sm);
      border: 1px solid var(--calcite-ui-border-input);
      border-radius: var(--calcite-border-radius);
      font-family: inherit;
      font-size: var(--calcite-font-size-sm);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    .search-input:focus {
      border-color: var(--calcite-ui-brand);
      box-shadow: 0 0 0 1px var(--calcite-ui-brand);
    }

    .search-input::placeholder {
      color: var(--calcite-ui-text-3);
    }

    .size-filter {
      height: 32px;
      padding: 0 var(--calcite-spacing-sm);
      border: 1px solid var(--calcite-ui-border-input);
      border-radius: var(--calcite-border-radius);
      font-family: inherit;
      font-size: var(--calcite-font-size-sm);
      background: var(--calcite-ui-foreground-1);
      cursor: pointer;
      outline: none;
      min-width: 80px;
    }

    .size-filter:focus {
      border-color: var(--calcite-ui-brand);
      box-shadow: 0 0 0 1px var(--calcite-ui-brand);
    }

    .mode-toggle {
      display: flex;
      border: 1px solid var(--calcite-ui-border-input);
      border-radius: var(--calcite-border-radius);
      overflow: hidden;
      height: 32px;
    }

    .mode-toggle-btn {
      padding: 0 12px;
      border: none;
      background: var(--calcite-ui-foreground-1);
      font-family: inherit;
      font-size: var(--calcite-font-size-sm);
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .mode-toggle-btn:first-child {
      border-right: 1px solid var(--calcite-ui-border-input);
    }

    .mode-toggle-btn:hover {
      background: var(--calcite-ui-foreground-2);
    }

    .mode-toggle-btn.active {
      background: var(--calcite-ui-brand);
      color: white;
    }

    .mode-icon {
      width: 14px;
      height: 14px;
    }

    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* ============================================
       SIDEBAR - Categories
       ============================================ */
    
    .sidebar {
      width: 180px;
      background: var(--calcite-ui-foreground-1);
      border-right: 1px solid var(--calcite-ui-border-2);
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: var(--calcite-spacing-sm);
      font-size: var(--calcite-font-size-sm);
      font-weight: 600;
      color: var(--calcite-ui-text-2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--calcite-ui-border-3);
      position: sticky;
      top: 0;
      background: var(--calcite-ui-foreground-1);
    }

    .category-list {
      list-style: none;
    }

    .category-item {
      padding: var(--calcite-spacing-xs) var(--calcite-spacing-sm);
      font-size: var(--calcite-font-size-sm);
      color: var(--calcite-ui-text-2);
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: all 0.15s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .category-item:hover {
      background: var(--calcite-ui-foreground-2);
      color: var(--calcite-ui-text-1);
    }

    .category-item.active {
      background: var(--calcite-ui-foreground-3);
      border-left-color: var(--calcite-ui-brand);
      color: var(--calcite-ui-brand);
      font-weight: 500;
    }

    .category-count {
      font-size: 11px;
      color: var(--calcite-ui-text-3);
      background: var(--calcite-ui-foreground-3);
      padding: 2px 6px;
      border-radius: 10px;
    }

    .category-item.active .category-count {
      background: var(--calcite-ui-brand);
      color: var(--calcite-ui-text-inverse);
    }

    /* ============================================
       ICON GRID
       ============================================ */
    
    .icon-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .icon-panel-header {
      padding: var(--calcite-spacing-sm) var(--calcite-spacing-md);
      background: var(--calcite-ui-foreground-1);
      border-bottom: 1px solid var(--calcite-ui-border-3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .icon-count {
      font-size: var(--calcite-font-size-sm);
      color: var(--calcite-ui-text-2);
    }

    .icon-grid-container {
      flex: 1;
      overflow-y: auto;
      padding: var(--calcite-spacing-md);
    }

    .icon-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
      gap: var(--calcite-spacing-xs);
    }

    .icon-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: var(--calcite-spacing-xs);
      border-radius: var(--calcite-border-radius);
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
    }

    .icon-card:hover {
      background: var(--calcite-ui-foreground-1);
      border-color: var(--calcite-ui-border-2);
      box-shadow: var(--calcite-shadow-sm);
    }

    .icon-card.selected {
      background: #e5f3fb;
      border-color: var(--calcite-ui-brand);
    }

    .icon-preview {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: var(--calcite-spacing-xxs);
    }

    .icon-preview svg {
      width: 100%;
      height: 100%;
    }

    .icon-svg {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .icon-svg svg {
      width: 100%;
      height: 100%;
      max-width: 32px;
      max-height: 32px;
    }

    /* Placeholder for icons without preview */
    .icon-placeholder {
      width: 32px;
      height: 32px;
      background: var(--calcite-ui-foreground-3);
      border-radius: var(--calcite-border-radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--calcite-ui-text-3);
      font-size: 10px;
    }

    .icon-name {
      font-size: 10px;
      color: var(--calcite-ui-text-2);
      text-align: center;
      word-break: break-word;
      line-height: 1.2;
      max-width: 100%;
    }

    .icon-size-badge {
      font-size: 9px;
      color: var(--calcite-ui-text-3);
      margin-top: 2px;
    }

    /* ============================================
       FOOTER / ACTIONS
       ============================================ */
    
    .footer {
      padding: var(--calcite-spacing-sm) var(--calcite-spacing-md);
      background: var(--calcite-ui-foreground-1);
      border-top: 1px solid var(--calcite-ui-border-2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }

    .selection-info {
      font-size: var(--calcite-font-size-sm);
      color: var(--calcite-ui-text-2);
    }

    .btn {
      height: 32px;
      padding: 0 var(--calcite-spacing-md);
      border-radius: var(--calcite-border-radius);
      font-family: inherit;
      font-size: var(--calcite-font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      outline: none;
    }

    .btn-primary {
      background: var(--calcite-ui-brand);
      color: var(--calcite-ui-text-inverse);
    }

    .btn-primary:hover {
      background: var(--calcite-ui-brand-hover);
    }

    .btn-primary:active {
      background: var(--calcite-ui-brand-press);
    }

    .btn-primary:disabled {
      background: var(--calcite-ui-border-1);
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--calcite-ui-foreground-1);
      color: var(--calcite-ui-text-1);
      border: 1px solid var(--calcite-ui-border-input);
    }

    .btn-secondary:hover {
      background: var(--calcite-ui-foreground-2);
    }

    .button-group {
      display: flex;
      gap: var(--calcite-spacing-xs);
    }

    /* ============================================
       EMPTY STATE
       ============================================ */
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--calcite-ui-text-3);
      text-align: center;
      padding: var(--calcite-spacing-lg);
    }

    .empty-state-icon {
      width: 48px;
      height: 48px;
      margin-bottom: var(--calcite-spacing-md);
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: var(--calcite-font-size-md);
      font-weight: 500;
      margin-bottom: var(--calcite-spacing-xs);
    }

    .empty-state-message {
      font-size: var(--calcite-font-size-sm);
    }

    /* ============================================
       LOADING STATE
       ============================================ */
    
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--calcite-ui-text-2);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--calcite-ui-border-2);
      border-top-color: var(--calcite-ui-brand);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: var(--calcite-spacing-sm);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ============================================
       JSON IMPORT SECTION
       ============================================ */
    
    .import-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: var(--calcite-spacing-lg);
      text-align: center;
    }

    .import-dropzone {
      width: 100%;
      max-width: 400px;
      padding: var(--calcite-spacing-lg);
      border: 2px dashed var(--calcite-ui-border-1);
      border-radius: var(--calcite-border-radius);
      background: var(--calcite-ui-foreground-1);
      cursor: pointer;
      transition: all 0.15s;
    }

    .import-dropzone:hover,
    .import-dropzone.dragover {
      border-color: var(--calcite-ui-brand);
      background: #f5fafd;
    }

    .import-dropzone-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto var(--calcite-spacing-md);
      color: var(--calcite-ui-text-3);
    }

    .import-dropzone-title {
      font-size: var(--calcite-font-size-md);
      font-weight: 500;
      margin-bottom: var(--calcite-spacing-xs);
    }

    .import-dropzone-message {
      font-size: var(--calcite-font-size-sm);
      color: var(--calcite-ui-text-3);
    }

    #file-input {
      display: none;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--calcite-ui-foreground-2);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--calcite-ui-border-1);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--calcite-ui-text-3);
    }
  </style>
</head>
<body>
  <div class="plugin-container">
    <!-- Header with search -->
    <div class="header">
      <div class="header-title">ArcGIS Icon Browser</div>
      <div class="search-container">
        <input 
          type="text" 
          class="search-input" 
          id="search-input" 
          placeholder="Search icons..."
          disabled
        />
        <select class="size-filter" id="size-filter" disabled>
          <option value="all">All sizes</option>
        </select>
        <div class="mode-toggle">
          <button class="mode-toggle-btn active" id="mode-light" title="Light mode (A)">
            <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="12" r="5"/>
              <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
            </svg>
            Light
          </button>
          <button class="mode-toggle-btn" id="mode-dark" title="Dark mode (B)">
            <svg class="mode-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
            Dark
          </button>
        </div>
      </div>
    </div>

    <!-- Main content area -->
    <div class="main-content">
      <!-- Category sidebar -->
      <div class="sidebar" id="sidebar">
        <div class="sidebar-header">Categories</div>
        <ul class="category-list" id="category-list">
          <!-- Categories populated by JS -->
        </ul>
      </div>

      <!-- Icon grid panel -->
      <div class="icon-panel">
        <div class="icon-panel-header">
          <span class="icon-count" id="icon-count">0 icons</span>
        </div>
        <div class="icon-grid-container" id="icon-grid-container">
          <!-- Loading state (shown while fetching remote JSON) -->
          <div class="loading-container" id="loading-section" style="display: none;">
            <div class="loading-spinner"></div>
            <div>Loading icons...</div>
          </div>

          <!-- Initial state: JSON import (fallback) -->
          <div class="import-section" id="import-section" style="display: none;">
            <div class="import-dropzone" id="import-dropzone">
              <svg class="import-dropzone-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <div class="import-dropzone-title">Import Icon Metadata</div>
              <div class="import-dropzone-message">
                Drop your JSON file here or click to browse
              </div>
            </div>
            <input type="file" id="file-input" accept=".json" />
          </div>

          <!-- Icon grid (hidden initially) -->
          <div class="icon-grid" id="icon-grid" style="display: none;">
            <!-- Icons populated by JS -->
          </div>

          <!-- Empty state (hidden initially) -->
          <div class="empty-state" id="empty-state" style="display: none;">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <div class="empty-state-title">No icons found</div>
            <div class="empty-state-message">Try adjusting your search or filters</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer with actions -->
    <div class="footer">
      <span class="selection-info" id="selection-info">Click an icon to insert</span>
      <div class="button-group">
        <button class="btn btn-secondary" id="clear-btn" disabled>Clear Selection</button>
        <button class="btn btn-primary" id="insert-btn" disabled>Insert Selected</button>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================

    const REPO_BASE = 'https://raw.githubusercontent.com/manulcosta-ds/icon-esri/main';
    const JSON_URL = REPO_BASE + '/icons.json';
    const THUMBNAILS_URL = REPO_BASE + '/thumbnails.json';

    // How long (ms) to consider cached data fresh before re-fetching.
    // Default: 24 hours. Set to 0 to always fetch.
    const CACHE_MAX_AGE_MS = 24 * 60 * 60 * 1000;

    // ============================================
    // STATE
    // ============================================
    
    let allIcons = [];
    let filteredIcons = [];
    let selectedIcons = new Set();
    let categories = [];
    let sizes = [];
    let currentCategory = 'all';
    let currentSize = 'all';
    let searchQuery = '';
    let currentMode = 'A'; // A = Light, B = Dark

    // ============================================
    // DOM ELEMENTS
    // ============================================
    
    const searchInput = document.getElementById('search-input');
    const sizeFilter = document.getElementById('size-filter');
    const categoryList = document.getElementById('category-list');
    const iconGrid = document.getElementById('icon-grid');
    const iconCount = document.getElementById('icon-count');
    const selectionInfo = document.getElementById('selection-info');
    const insertBtn = document.getElementById('insert-btn');
    const clearBtn = document.getElementById('clear-btn');
    const importSection = document.getElementById('import-section');
    const importDropzone = document.getElementById('import-dropzone');
    const fileInput = document.getElementById('file-input');
    const emptyState = document.getElementById('empty-state');
    const loadingSection = document.getElementById('loading-section');
    const modeLightBtn = document.getElementById('mode-light');
    const modeDarkBtn = document.getElementById('mode-dark');

    // ============================================
    // MODE TOGGLE
    // ============================================
    
    modeLightBtn.addEventListener('click', () => {
      currentMode = 'A';
      modeLightBtn.classList.add('active');
      modeDarkBtn.classList.remove('active');
    });

    modeDarkBtn.addEventListener('click', () => {
      currentMode = 'B';
      modeDarkBtn.classList.add('active');
      modeLightBtn.classList.remove('active');
    });

    // ============================================
    // AUTO-FETCH & CACHE LOGIC
    // ============================================

    function showLoading() {
      loadingSection.style.display = 'flex';
      importSection.style.display = 'none';
      iconGrid.style.display = 'none';
      emptyState.style.display = 'none';
    }

    function showManualImport() {
      loadingSection.style.display = 'none';
      importSection.style.display = 'flex';
    }

    function cacheIconData(data) {
      parent.postMessage({
        pluginMessage: {
          type: 'cache-data',
          payload: { icons: data, timestamp: Date.now() }
        }
      }, '*');
    }

    function cacheThumbnails(thumbs) {
      parent.postMessage({
        pluginMessage: {
          type: 'cache-thumbnails',
          payload: { thumbnails: thumbs, timestamp: Date.now() }
        }
      }, '*');
    }

    async function fetchJSON(url) {
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('HTTP ' + response.status);
        return await response.json();
      } catch (err) {
        console.warn('Fetch failed (' + url + '):', err.message);
        return null;
      }
    }

    function applyThumbnails(thumbs) {
      if (!thumbs || typeof thumbs !== 'object') return;
      allIcons.forEach(icon => {
        if (thumbs[icon.id]) {
          icon.svg_thumbnail = thumbs[icon.id];
        }
      });
      renderIconGrid();
    }

    function loadThumbnails(cachedThumbs) {
      if (cachedThumbs && cachedThumbs.thumbnails) {
        const age = Date.now() - (cachedThumbs.timestamp || 0);
        const isFresh = CACHE_MAX_AGE_MS > 0 && age < CACHE_MAX_AGE_MS;

        applyThumbnails(cachedThumbs.thumbnails);

        if (!isFresh && THUMBNAILS_URL) {
          fetchJSON(THUMBNAILS_URL).then(data => {
            if (data) {
              cacheThumbnails(data);
              applyThumbnails(data);
            }
          });
        }
        return;
      }

      if (THUMBNAILS_URL) {
        fetchJSON(THUMBNAILS_URL).then(data => {
          if (data) {
            cacheThumbnails(data);
            applyThumbnails(data);
          }
        });
      }
    }

    function handleCachedData(cached) {
      if (cached && cached.icons && Array.isArray(cached.icons) && cached.icons.length > 0) {
        const age = Date.now() - (cached.timestamp || 0);
        const isFresh = CACHE_MAX_AGE_MS > 0 && age < CACHE_MAX_AGE_MS;

        initializeWithData(cached.icons);

        if (!isFresh && JSON_URL) {
          fetchJSON(JSON_URL).then(data => {
            if (data && Array.isArray(data) && data.length > 0) {
              cacheIconData(data);
              initializeWithData(data);
            }
          });
        }

        parent.postMessage({
          pluginMessage: { type: 'get-cached-thumbnails' }
        }, '*');
        return;
      }

      if (JSON_URL) {
        showLoading();
        fetchJSON(JSON_URL).then(data => {
          if (data && Array.isArray(data) && data.length > 0) {
            cacheIconData(data);
            initializeWithData(data);
            parent.postMessage({
              pluginMessage: { type: 'get-cached-thumbnails' }
            }, '*');
          } else {
            showManualImport();
          }
        });
      } else {
        showManualImport();
      }
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === 'cached-data') {
        handleCachedData(msg.payload);
      }

      if (msg.type === 'cached-thumbnails') {
        loadThumbnails(msg.payload);
      }
    };

    // On startup, ask the plugin sandbox for cached data
    parent.postMessage({
      pluginMessage: { type: 'get-cached-data' }
    }, '*');

    // ============================================
    // FILE IMPORT (manual fallback)
    // ============================================
    
    importDropzone.addEventListener('click', () => fileInput.click());
    
    importDropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      importDropzone.classList.add('dragover');
    });

    importDropzone.addEventListener('dragleave', () => {
      importDropzone.classList.remove('dragover');
    });

    importDropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      importDropzone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.json')) {
        loadJSONFile(file);
      }
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        loadJSONFile(file);
      }
    });

    function loadJSONFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (Array.isArray(data) && data.length > 0) {
            cacheIconData(data);
            initializeWithData(data);
          } else {
            alert('Invalid JSON format. Expected an array of icon objects.');
          }
        } catch (err) {
          alert('Error parsing JSON file: ' + err.message);
        }
      };
      reader.readAsText(file);
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    
    function initializeWithData(data) {
      allIcons = data.filter(icon => icon.component_key);
      
      if (allIcons.length === 0) {
        alert('No icons with component_key found in the JSON.');
        showManualImport();
        return;
      }

      const categorySet = new Map();
      allIcons.forEach(icon => {
        const key = icon.context_key || 'uncategorized';
        const name = icon.context || key;
        if (!categorySet.has(key)) {
          categorySet.set(key, { key, name, count: 0 });
        }
        categorySet.get(key).count++;
      });
      categories = Array.from(categorySet.values()).sort((a, b) => a.name.localeCompare(b.name));

      sizes = [...new Set(allIcons.map(icon => icon.size))].sort((a, b) => a - b);

      buildCategoryList();
      buildSizeFilter();
      
      searchInput.disabled = false;
      sizeFilter.disabled = false;

      loadingSection.style.display = 'none';
      importSection.style.display = 'none';
      iconGrid.style.display = 'grid';

      filterIcons();
    }

    // ============================================
    // CATEGORY LIST
    // ============================================
    
    function buildCategoryList() {
      const totalCount = allIcons.length;
      
      let html = `
        <li class="category-item active" data-category="all">
          <span>All Icons</span>
          <span class="category-count">${totalCount}</span>
        </li>
      `;

      categories.forEach(cat => {
        html += `
          <li class="category-item" data-category="${cat.key}">
            <span>${formatCategoryName(cat.name)}</span>
            <span class="category-count">${cat.count}</span>
          </li>
        `;
      });

      categoryList.innerHTML = html;

      // Add click handlers
      categoryList.querySelectorAll('.category-item').forEach(item => {
        item.addEventListener('click', () => {
          categoryList.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          currentCategory = item.dataset.category;
          filterIcons();
        });
      });
    }

    function formatCategoryName(name) {
      // Convert "01_MapView_A" to "Map View A"
      return name
        .replace(/^\d+_/, '')  // Remove leading number prefix
        .replace(/_/g, ' ')    // Replace underscores with spaces
        .replace(/([a-z])([A-Z])/g, '$1 $2');  // Add space before capitals
    }

    // ============================================
    // SIZE FILTER
    // ============================================
    
    function buildSizeFilter() {
      let html = '<option value="all">All sizes</option>';
      sizes.forEach(size => {
        html += `<option value="${size}">${size}px</option>`;
      });
      sizeFilter.innerHTML = html;
    }

    sizeFilter.addEventListener('change', () => {
      currentSize = sizeFilter.value;
      filterIcons();
    });

    // ============================================
    // SEARCH
    // ============================================
    
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchQuery = searchInput.value.toLowerCase().trim();
        filterIcons();
      }, 150);
    });

    // ============================================
    // FILTERING
    // ============================================
    
    function filterIcons() {
      filteredIcons = allIcons.filter(icon => {
        // Category filter
        if (currentCategory !== 'all' && icon.context_key !== currentCategory) {
          return false;
        }

        // Size filter
        if (currentSize !== 'all' && icon.size !== parseInt(currentSize)) {
          return false;
        }

        // Search filter
        if (searchQuery) {
          const searchFields = [
            icon.icon_name,
            icon.icon_key,
            icon.context,
            icon.context_key,
            icon.component_name,
            icon.tags ? icon.tags.join(' ') : ''
          ].filter(Boolean).join(' ').toLowerCase();
          
          if (!searchFields.includes(searchQuery)) {
            return false;
          }
        }

        return true;
      });

      renderIconGrid();
      updateIconCount();
    }

    // ============================================
    // ICON GRID RENDERING
    // ============================================
    
    function renderIconGrid() {
      if (filteredIcons.length === 0) {
        iconGrid.style.display = 'none';
        emptyState.style.display = 'flex';
        return;
      }

      iconGrid.style.display = 'grid';
      emptyState.style.display = 'none';

      // Render icons
      iconGrid.innerHTML = filteredIcons.map(icon => {
        const isSelected = selectedIcons.has(icon.id);
        const hasThumbnail = icon.svg_thumbnail;
        
        let previewContent;
        if (hasThumbnail) {
          // Use the embedded SVG
          previewContent = '<div class="icon-svg">' + icon.svg_thumbnail + '</div>';
        } else {
          // Fallback to placeholder
          previewContent = '<div class="icon-placeholder">' + icon.size + '</div>';
        }
        
        return '<div class="icon-card ' + (isSelected ? 'selected' : '') + '" data-id="' + icon.id + '">' +
          '<div class="icon-preview">' + previewContent + '</div>' +
          '<div class="icon-name">' + icon.icon_name + '</div>' +
          '<div class="icon-size-badge">' + icon.size + 'px</div>' +
        '</div>';
      }).join('');

      // Add click handlers
      iconGrid.querySelectorAll('.icon-card').forEach(card => {
        card.addEventListener('click', (e) => {
          const id = card.dataset.id;
          
          if (e.shiftKey || e.ctrlKey || e.metaKey) {
            // Multi-select
            toggleIconSelection(id, card);
          } else {
            // Single click - insert immediately
            const icon = allIcons.find(i => i.id === id);
            if (icon) {
              insertIcon(icon);
            }
          }
        });
      });
    }

    function toggleIconSelection(id, card) {
      if (selectedIcons.has(id)) {
        selectedIcons.delete(id);
        card.classList.remove('selected');
      } else {
        selectedIcons.add(id);
        card.classList.add('selected');
      }
      updateSelectionInfo();
    }

    // ============================================
    // UI UPDATES
    // ============================================
    
    function updateIconCount() {
      const total = filteredIcons.length;
      const text = total === 1 ? '1 icon' : `${total} icons`;
      iconCount.textContent = text;
    }

    function updateSelectionInfo() {
      const count = selectedIcons.size;
      if (count === 0) {
        selectionInfo.textContent = 'Click an icon to insert';
        insertBtn.disabled = true;
        clearBtn.disabled = true;
      } else {
        selectionInfo.textContent = `${count} icon${count > 1 ? 's' : ''} selected`;
        insertBtn.disabled = false;
        clearBtn.disabled = false;
      }
    }

    // ============================================
    // INSERT ACTIONS
    // ============================================
    
    function insertIcon(icon) {
      parent.postMessage({
        pluginMessage: {
          type: 'insert-icon',
          iconData: icon,
          mode: currentMode
        }
      }, '*');
    }

    function insertSelectedIcons() {
      const icons = allIcons.filter(icon => selectedIcons.has(icon.id));
      if (icons.length > 0) {
        parent.postMessage({
          pluginMessage: {
            type: 'insert-multiple',
            icons: icons,
            mode: currentMode
          }
        }, '*');
        clearSelection();
      }
    }

    function clearSelection() {
      selectedIcons.clear();
      iconGrid.querySelectorAll('.icon-card.selected').forEach(card => {
        card.classList.remove('selected');
      });
      updateSelectionInfo();
    }

    // Button handlers
    insertBtn.addEventListener('click', insertSelectedIcons);
    clearBtn.addEventListener('click', clearSelection);

    // ============================================
    // KEYBOARD SHORTCUTS
    // ============================================
    
    document.addEventListener('keydown', (e) => {
      // Escape to clear selection
      if (e.key === 'Escape') {
        clearSelection();
      }
      
      // Cmd/Ctrl + A to select all visible
      if ((e.metaKey || e.ctrlKey) && e.key === 'a' && document.activeElement !== searchInput) {
        e.preventDefault();
        filteredIcons.forEach(icon => selectedIcons.add(icon.id));
        iconGrid.querySelectorAll('.icon-card').forEach(card => card.classList.add('selected'));
        updateSelectionInfo();
      }
    });

    // Focus search on load
    searchInput.focus();
  </script>
</body>
</html>
